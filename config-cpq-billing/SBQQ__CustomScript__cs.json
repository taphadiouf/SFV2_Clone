{
    "records": [
        {
            "attributes": {
                "type": "SBQQ__CustomScript__c",
                "referenceId": "SBQQ__CustomScript__cRef1"
            },
            "IsDeleted": false,
            "Name": "QuoteCalculatorPlugin Backup 25th NOv",
            "SBQQ__Code__c": "export function onAfterCalculate(quote, lines, conn) {\n    console.log('Quote : ' + quote.record[\"Id\"]);\n    console.log('LPCR_Contracted_Checkbox__c:');\n    console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);\n    if (quote.record[\"SBQQ__Type__c\"] == 'Renewal' && quote.record[\"LPCR_Added_Product_Using_QCP__c\"] == false && quote.record[\"LPCR_Contracted_Checkbox__c\"] == true) {\n        var newRecords = [];\n\n        var conditions = {\n            ProductCode: 'FraisInscriptionMac'\n        };\n        var fields = ['Id', 'ProductCode'];\n        return conn.sobject('Product2')\n            .find(conditions, fields)\n            .execute(function(err, records) {\n                console.log(records);\n                var product = records[0].Id;\n                console.log('product ' + product);\n                if (err) {\n                    return Promise.reject(err);\n                } else {\n\n                    if (true) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        newRecords.push({\n                            SBQQ__Product__c: product,\n                            SBQQ__Quote__c: quote.record[\"Id\"],\n                            SBQQ__Number__c: 100\n                        });\n                    }\n                    if (newRecords.length) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        return conn.sobject('SBQQ__QuoteLine__c').create(newRecords, function(err, ret) {\n                            console.log(ret);\n                        });\n                    }\n                }\n            });\n    }\n    return Promise.resolve();\n\n}\n\n\nexport function onBeforeCalculate(quoteModel, quoteLineModels, conn) {\n\nquoteModel.record[\"SBQQ__SubscriptionTerm__c\"] = 100;\n\nconsole.log('onBeforePriceRules : ');\n    console.log(quoteModel);\n\n    let recordTypeMap = new Map();\n    var qliUpgradedSubscriptionList = [];\n    let qliUpgradedSubscriptionMap = new Map();\n\n    if (quoteLineModels) {\n        quoteLineModels.forEach(function(line) {\n\n\n\n\n            if (line.record['SBQQ__UpgradedSubscription__c']) {\n                qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);\n            }\n        });\n        if (qliUpgradedSubscriptionList.length) {\n            var codeList = \"('\" + qliUpgradedSubscriptionList.join(\"', '\") + \"')\";\n\n             conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN ' + codeList)\n                .then(function(results) {\n                    if (results.totalSize) {\n                        console.log('@@@ SBQQ__UpgradedSubscription__c ');\n                        results.records.forEach(function(record) {\n                            console.log(record);\n                            qliUpgradedSubscriptionMap.set(''+record.Id, record.SBQQ__EndDate__c);\n                        });\n                    }\n\t\t\t\t\t\n\t\t\t\t\tconsole.log('@@@ qliUpgradedSubscriptionMap values');\n\t\t\t\t\tconsole.log(qliUpgradedSubscriptionMap);\n\t\t\t\t\t\n                    \n                });\n        }\n\t\t\n\t\tif (quoteModel) {\n\n\n\n                        var conditions = {\n                            DeveloperName: 'Referencement',\n                            SobjectType: 'SBQQ__Quote__c'\n                        };\n                        var fields = ['Id', 'DeveloperName'];\n                        return conn.sobject('RecordType')\n                            .find(conditions, fields)\n                            .execute(function(err, records) {\n                                if (typeof records !== 'undefined') {\n                                    records.forEach(function(recordType) {\n                                        recordTypeMap.set(recordType.Id, recordType.DeveloperName);\n                                    });\n                                }\n                                console.log(recordTypeMap);\n\n                                if (typeof quoteLineModels !== 'undefined') {\n                                    quoteLineModels.forEach(function(line) {\n                                        console.log('@@@ QLI ');\n                                        console.log(line);\n\n                                        line.record['SBQQ__SubscriptionTerm__c'] = 1000;\n\n                                        var quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                        var quoteEndDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__EndDate__c']);\n\n                                        console.log(quoteStartDate);\n                                        console.log(quoteEndDate);\n\n                                        if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] == 'Amendment') {\n                                            //we add this check to not override dates for the cloned line from ‘clone/cancel’ \n                                            // it will have the exact dates as the original QL\n                                            console.log('onBeforePriceRules RecordType and Type is true');\n                                            if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] === null) {\n                                                console.log('onBeforePriceRules  SBQQ_StartDate_c is NULL true');\n\n                                                //Not a Newly added QL in the amendment\n                                                if (line.record['SBQQ__PriorQuantity__c'] !== null) {\n                                                    console.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null');\n                                                    line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t//line.record['SBQQ__EndDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\tif(line.record['SBQQ__UpgradedSubscription__c'] !== null){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null SBQQ__UpgradedSubscription__c');\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tline.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n                                                    \n                                                } else {\n                                                    //Newly added QL in the amendment\n                                                    var DateDebut = new Date(line.record['LPCR_DateDebut__c']);\n                                                    var DateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                                    if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n                                                        if (DateDebut.getFullYear() === quoteStartDate.getFullYear()) {\n                                                            console.log('onBeforePriceRules  both year equal');\n                                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                                            line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                                            if (line.record['LPCR_DateFin__c'] != null && DateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                                                line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                                                console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');\n                                                            } else {\n                                                                line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                                                console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate>');\n                                                            }\n                                                        } else {\n                                                            line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                                            console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');\n                                                        }\n                                                    }\n                                                }\n\n                                            } else if (line.record['SBQQ__StartDate__c'] !== null && line.record['SBQQ__EndDate__c'] === null) {\n\t\t\t\t\t\t\t\t\t\t\t\tconsole.log('onBeforePriceRules  only end date null'+ line.record['SBQQ__UpgradedSubscription__c']);\n\t\t\t\t\t\t\t\t\t\t\t\tif(line.record['SBQQ__UpgradedSubscription__c'] !== null){\n\t\t\t\t\t\t\t\t\t\t\t\t\tif(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log('onBeforePriceRules  only end date null : set end date ' );\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log(qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']));\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tline.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t}\n                                                \n                                            } else if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] !== null) {\n                                                line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n                                            }\n                                        } else if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] != 'Amendment' && line.record['SBQQ__ChargeType__c'] == 'Recurring') {\n                                            \n                                            line.record['SBQQ__SubscriptionTerm__c'] = 999;\n\n                                            console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');\n                                            console.log('Date debut ' + line.record['LPCR_DateDebut__c']);\n                                            var quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                            console.log(quoteStartDate);\n\n                                            //is the QL supposed to  start in this year? already started?\n                                            if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n\n                                                console.log('LPCR_DateDebut__c not null');\n                                                var dateDebut = new Date(line.record['LPCR_DateDebut__c']);\n\n                                                if (dateDebut.getFullYear() <= quoteStartDate.getFullYear()) {\n                                                    //is the QL still alive in this year? not ended?\t\t\t\t\t\t\t\n\n                                                    console.log('LPCR_DateFin__c not null');\n                                                    var dateFin = new Date(line.record['LPCR_DateFin__c']);\n                                                    console.log(dateFin);\n\n                                                    if (dateFin.getFullYear() >= quoteStartDate.getFullYear()) {\n\n                                                        line.record['LPCR_HoldBilling__c'] = 'No';\n                                                        console.log('onBeforePriceRules  LPCR_HoldBilling__c is set No');\n\n                                                        //SBQQ__EndDate__c logic\n                                                        if (dateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n\n                                                            line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                                            console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');\n                                                        } else {\n\n                                                            line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                                            console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate> ' + line.record['SBQQ__EndDate__c']);\n                                                        }\n\n                                                        //SBQQ__StartDate__c logic\n                                                        if (dateDebut.getFullYear() == quoteStartDate.getFullYear()) {\n                                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                                            console.log('onBeforePriceRules  SBQQ__StartDate__c is set line LPCR_DateDebut__c');\n                                                        }\n                                                    } else {\n\n                                                        line.record['SBQQ__Quantity__c'] = 0;\n                                                        console.log('onBeforePriceRules  SBQQ__Quantity__c is set 0');\n                                                    }\n                                                } else {\n                                                    line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                                    console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');\n                                                }\n                                            }\n\n                                        }\n\n                                    });\n                                }\n                            });\n                    }\n    }\n    console.log('@@@ codeList ');\n    console.log(codeList);\n\n\n    if (quoteLineModels) {\n        lines.forEach((line) => {\n            const consumptionUnitPrice = line.record['LPCR_TauxHoraire__c'];\n\n            if (consumptionUnitPrice > 0 && line.consumptionSchedules) {\n                line.consumptionSchedules.forEach((cs, index) => {\n                    const rates = cs.getRates();\n                    if (rates) {\n                        rates.forEach((rate, index) => {\n                            const newPrice = consumptionUnitPrice;\n                            rate.set('SBQQ__Price__c', newPrice);\n                        });\n                    }\n                });\n            }\n\n        });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforePriceRules(quoteModel, quoteLineModels, conn) {\n    console.log('onBeforePriceRules : ');\n    console.log(quoteModel);\n\n    let recordTypeMap = new Map();\n    var qliUpgradedSubscriptionList = [];\n    let qliUpgradedSubscriptionMap = new Map();\n\n    if (quoteLineModels) {\n        quoteLineModels.forEach(function(line) {\n            if (line.record['SBQQ__UpgradedSubscription__c']) {\n                qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);\n            }\n        });\n        if (qliUpgradedSubscriptionList.length) {\n            var codeList = \"('\" + qliUpgradedSubscriptionList.join(\"', '\") + \"')\";\n\n             conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN ' + codeList)\n                .then(function(results) {\n                    if (results.totalSize) {\n                        console.log('@@@ SBQQ__UpgradedSubscription__c ');\n                        results.records.forEach(function(record) {\n                            console.log(record);\n                            qliUpgradedSubscriptionMap.set(''+record.Id, record.SBQQ__EndDate__c);\n                        });\n                    }\n\t\t\t\t\t\n\t\t\t\t\tconsole.log('@@@ qliUpgradedSubscriptionMap values');\n\t\t\t\t\tconsole.log(qliUpgradedSubscriptionMap);\n\t\t\t\t\t\n                    \n                });\n        }\n\t\t\n\t\tif (quoteModel) {\n                        var conditions = {\n                            DeveloperName: 'Referencement',\n                            SobjectType: 'SBQQ__Quote__c'\n                        };\n                        var fields = ['Id', 'DeveloperName'];\n                        return conn.sobject('RecordType')\n                            .find(conditions, fields)\n                            .execute(function(err, records) {\n                                if (typeof records !== 'undefined') {\n                                    records.forEach(function(recordType) {\n                                        recordTypeMap.set(recordType.Id, recordType.DeveloperName);\n                                    });\n                                }\n                                console.log(recordTypeMap);\n\n                                if (typeof quoteLineModels !== 'undefined') {\n                                    quoteLineModels.forEach(function(line) {\n                                        console.log('@@@ QLI ');\n                                        console.log(line);\n\n                                        var quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                        var quoteEndDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__EndDate__c']);\n\n                                        console.log(quoteStartDate);\n                                        console.log(quoteEndDate);\n\n                                        if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] == 'Amendment') {\n                                            //we add this check to not override dates for the cloned line from ‘clone/cancel’ \n                                            // it will have the exact dates as the original QL\n                                            console.log('onBeforePriceRules RecordType and Type is true');\n                                            if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] === null) {\n                                                console.log('onBeforePriceRules  SBQQ_StartDate_c is NULL true');\n\n                                                //Not a Newly added QL in the amendment\n                                                if (line.record['SBQQ__PriorQuantity__c'] !== null) {\n                                                    console.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null');\n                                                    line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t//line.record['SBQQ__EndDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\tif(line.record['SBQQ__UpgradedSubscription__c'] !== null){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null SBQQ__UpgradedSubscription__c');\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tline.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n                                                    \n                                                } else {\n                                                    //Newly added QL in the amendment\n                                                    var DateDebut = new Date(line.record['LPCR_DateDebut__c']);\n                                                    var DateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                                    if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n                                                        if (DateDebut.getFullYear() === quoteStartDate.getFullYear()) {\n                                                            console.log('onBeforePriceRules  both year equal');\n                                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                                            line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                                            if (line.record['LPCR_DateFin__c'] != null && DateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                                                line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                                                console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');\n                                                            } else {\n                                                                line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                                                console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate>');\n                                                            }\n                                                        } else {\n                                                            line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                                            console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');\n                                                        }\n                                                    }\n                                                }\n\n                                            } else if (line.record['SBQQ__StartDate__c'] !== null && line.record['SBQQ__EndDate__c'] === null) {\n\t\t\t\t\t\t\t\t\t\t\t\tconsole.log('onBeforePriceRules  only end date null'+ line.record['SBQQ__UpgradedSubscription__c']);\n\t\t\t\t\t\t\t\t\t\t\t\tif(line.record['SBQQ__UpgradedSubscription__c'] !== null){\n\t\t\t\t\t\t\t\t\t\t\t\t\tif(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log('onBeforePriceRules  only end date null : set end date ' );\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconsole.log(qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']));\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tline.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t\t}\n                                                \n                                            } else if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] !== null) {\n                                                line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n                                            }\n                                        } else if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] != 'Amendment' && line.record['SBQQ__ChargeType__c'] == 'Recurring') {\n\n                                            console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');\n                                            console.log('Date debut ' + line.record['LPCR_DateDebut__c']);\n                                            var quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                            console.log(quoteStartDate);\n\n                                            //is the QL supposed to  start in this year? already started?\n                                            if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n\n                                                console.log('LPCR_DateDebut__c not null');\n                                                var dateDebut = new Date(line.record['LPCR_DateDebut__c']);\n\n                                                if (dateDebut.getFullYear() <= quoteStartDate.getFullYear()) {\n                                                    //is the QL still alive in this year? not ended?\t\t\t\t\t\t\t\n\n                                                    console.log('LPCR_DateFin__c not null');\n                                                    var dateFin = new Date(line.record['LPCR_DateFin__c']);\n                                                    console.log(dateFin);\n\n                                                    if (dateFin.getFullYear() >= quoteStartDate.getFullYear()) {\n\n                                                        line.record['LPCR_HoldBilling__c'] = 'No';\n                                                        console.log('onBeforePriceRules  LPCR_HoldBilling__c is set No');\n\n                                                        //SBQQ__EndDate__c logic\n                                                        if (dateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n\n                                                            line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                                            console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');\n                                                        } else {\n\n                                                            line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                                            console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate> ' + line.record['SBQQ__EndDate__c']);\n                                                        }\n\n                                                        //SBQQ__StartDate__c logic\n                                                        if (dateDebut.getFullYear() == quoteStartDate.getFullYear()) {\n                                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                                            console.log('onBeforePriceRules  SBQQ__StartDate__c is set line LPCR_DateDebut__c');\n                                                        }\n                                                    } else {\n\n                                                        line.record['SBQQ__Quantity__c'] = 0;\n                                                        console.log('onBeforePriceRules  SBQQ__Quantity__c is set 0');\n                                                    }\n                                                } else {\n                                                    line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                                    console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');\n                                                }\n                                            }\n\n                                        }\n\n                                    });\n                                }\n                            });\n                    }\n    }\n    console.log('@@@ codeList ');\n    console.log(codeList);\n\n    return Promise.resolve();\n}\n\nexport function isFieldVisibleForObject(fieldName, quote, conn, objectName) {\n\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_TypeAvenant__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_DateResiliation__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n};",
            "SBQQ__QuoteFields__c": "LPCR_Added_Product_Using_QCP__c\nLPCR_Contracted_Checkbox__c",
            "SBQQ__QuoteLineFields__c": "LPCR_TauxHoraire__c\nLPCR_HoldBilling__c",
            "SBQQ__TranspiledCode__c": "'use strict';System.register('QCPlugin____UIDFiller____',[],function(_export,_context){\"use strict\";function onAfterCalculate(quote,lines,conn){console.log('Quote : '+quote.record[\"Id\"]);console.log('LPCR_Contracted_Checkbox__c:');console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);if(quote.record[\"SBQQ__Type__c\"]=='Renewal'&&quote.record[\"LPCR_Added_Product_Using_QCP__c\"]==false&&quote.record[\"LPCR_Contracted_Checkbox__c\"]==true){var newRecords=[];var conditions={ProductCode:'FraisInscriptionMac'};var fields=['Id','ProductCode'];return conn.sobject('Product2').find(conditions,fields).execute(function(err,records){console.log(records);var product=records[0].Id;console.log('product '+product);if(err){return Promise.reject(err);}else{if(true){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;newRecords.push({SBQQ__Product__c:product,SBQQ__Quote__c:quote.record[\"Id\"],SBQQ__Number__c:100});}if(newRecords.length){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;return conn.sobject('SBQQ__QuoteLine__c').create(newRecords,function(err,ret){console.log(ret);});}}});}return Promise.resolve();}_export('onAfterCalculate',onAfterCalculate);function onBeforeCalculate(quoteModel,quoteLineModels,conn){quoteModel.record[\"SBQQ__SubscriptionTerm__c\"]=100;console.log('onBeforePriceRules : ');console.log(quoteModel);var recordTypeMap=new Map();var qliUpgradedSubscriptionList=[];var qliUpgradedSubscriptionMap=new Map();if(quoteLineModels){quoteLineModels.forEach(function(line){if(line.record['SBQQ__UpgradedSubscription__c']){qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);}});if(qliUpgradedSubscriptionList.length){var codeList=\"('\"+qliUpgradedSubscriptionList.join(\"', '\")+\"')\";conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN '+codeList).then(function(results){if(results.totalSize){console.log('@@@ SBQQ__UpgradedSubscription__c ');results.records.forEach(function(record){console.log(record);qliUpgradedSubscriptionMap.set(''+record.Id,record.SBQQ__EndDate__c);});}console.log('@@@ qliUpgradedSubscriptionMap values');console.log(qliUpgradedSubscriptionMap);});}if(quoteModel){var conditions={DeveloperName:'Referencement',SobjectType:'SBQQ__Quote__c'};var fields=['Id','DeveloperName'];return conn.sobject('RecordType').find(conditions,fields).execute(function(err,records){if(typeof records!=='undefined'){records.forEach(function(recordType){recordTypeMap.set(recordType.Id,recordType.DeveloperName);});}console.log(recordTypeMap);if(typeof quoteLineModels!=='undefined'){quoteLineModels.forEach(function(line){console.log('@@@ QLI ');console.log(line);line.record['SBQQ__SubscriptionTerm__c']=1000;var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);var quoteEndDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__EndDate__c']);console.log(quoteStartDate);console.log(quoteEndDate);if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']=='Amendment'){//we add this check to not override dates for the cloned line from ‘clone/cancel’ \n// it will have the exact dates as the original QL\nconsole.log('onBeforePriceRules RecordType and Type is true');if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']===null){console.log('onBeforePriceRules  SBQQ_StartDate_c is NULL true');//Not a Newly added QL in the amendment\nif(line.record['SBQQ__PriorQuantity__c']!==null){console.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null');line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];//line.record['SBQQ__EndDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\nif(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){console.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null SBQQ__UpgradedSubscription__c');line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else{//Newly added QL in the amendment\nvar DateDebut=new Date(line.record['LPCR_DateDebut__c']);var DateFin=new Date(line.record['LPCR_DateFin__c']);if(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){if(DateDebut.getFullYear()===quoteStartDate.getFullYear()){console.log('onBeforePriceRules  both year equal');line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];line.record['LPCR_HoldBilling__c']='No';if(line.record['LPCR_DateFin__c']!=null&&DateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate>');}}else{line.record['LPCR_HoldBilling__c']='Yes';console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');}}}}else if(line.record['SBQQ__StartDate__c']!==null&&line.record['SBQQ__EndDate__c']===null){console.log('onBeforePriceRules  only end date null'+line.record['SBQQ__UpgradedSubscription__c']);if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){console.log('onBeforePriceRules  only end date null : set end date ');console.log(qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']));line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']!==null){line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];}}else if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']!='Amendment'&&line.record['SBQQ__ChargeType__c']=='Recurring'){line.record['SBQQ__SubscriptionTerm__c']=999;console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');console.log('Date debut '+line.record['LPCR_DateDebut__c']);var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);console.log(quoteStartDate);//is the QL supposed to  start in this year? already started?\nif(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){console.log('LPCR_DateDebut__c not null');var dateDebut=new Date(line.record['LPCR_DateDebut__c']);if(dateDebut.getFullYear()<=quoteStartDate.getFullYear()){//is the QL still alive in this year? not ended?\t\t\t\t\t\t\t\nconsole.log('LPCR_DateFin__c not null');var dateFin=new Date(line.record['LPCR_DateFin__c']);console.log(dateFin);if(dateFin.getFullYear()>=quoteStartDate.getFullYear()){line.record['LPCR_HoldBilling__c']='No';console.log('onBeforePriceRules  LPCR_HoldBilling__c is set No');//SBQQ__EndDate__c logic\nif(dateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate> '+line.record['SBQQ__EndDate__c']);}//SBQQ__StartDate__c logic\nif(dateDebut.getFullYear()==quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];console.log('onBeforePriceRules  SBQQ__StartDate__c is set line LPCR_DateDebut__c');}}else{line.record['SBQQ__Quantity__c']=0;console.log('onBeforePriceRules  SBQQ__Quantity__c is set 0');}}else{line.record['LPCR_HoldBilling__c']='Yes';console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');}}}});}});}}console.log('@@@ codeList ');console.log(codeList);if(quoteLineModels){lines.forEach(function(line){var consumptionUnitPrice=line.record['LPCR_TauxHoraire__c'];if(consumptionUnitPrice>0&&line.consumptionSchedules){line.consumptionSchedules.forEach(function(cs,index){var rates=cs.getRates();if(rates){rates.forEach(function(rate,index){var newPrice=consumptionUnitPrice;rate.set('SBQQ__Price__c',newPrice);});}});}});}return Promise.resolve();}_export('onBeforeCalculate',onBeforeCalculate);function onBeforePriceRules(quoteModel,quoteLineModels,conn){console.log('onBeforePriceRules : ');console.log(quoteModel);var recordTypeMap=new Map();var qliUpgradedSubscriptionList=[];var qliUpgradedSubscriptionMap=new Map();if(quoteLineModels){quoteLineModels.forEach(function(line){if(line.record['SBQQ__UpgradedSubscription__c']){qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);}});if(qliUpgradedSubscriptionList.length){var codeList=\"('\"+qliUpgradedSubscriptionList.join(\"', '\")+\"')\";conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN '+codeList).then(function(results){if(results.totalSize){console.log('@@@ SBQQ__UpgradedSubscription__c ');results.records.forEach(function(record){console.log(record);qliUpgradedSubscriptionMap.set(''+record.Id,record.SBQQ__EndDate__c);});}console.log('@@@ qliUpgradedSubscriptionMap values');console.log(qliUpgradedSubscriptionMap);});}if(quoteModel){var conditions={DeveloperName:'Referencement',SobjectType:'SBQQ__Quote__c'};var fields=['Id','DeveloperName'];return conn.sobject('RecordType').find(conditions,fields).execute(function(err,records){if(typeof records!=='undefined'){records.forEach(function(recordType){recordTypeMap.set(recordType.Id,recordType.DeveloperName);});}console.log(recordTypeMap);if(typeof quoteLineModels!=='undefined'){quoteLineModels.forEach(function(line){console.log('@@@ QLI ');console.log(line);var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);var quoteEndDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__EndDate__c']);console.log(quoteStartDate);console.log(quoteEndDate);if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']=='Amendment'){//we add this check to not override dates for the cloned line from ‘clone/cancel’ \n// it will have the exact dates as the original QL\nconsole.log('onBeforePriceRules RecordType and Type is true');if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']===null){console.log('onBeforePriceRules  SBQQ_StartDate_c is NULL true');//Not a Newly added QL in the amendment\nif(line.record['SBQQ__PriorQuantity__c']!==null){console.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null');line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];//line.record['SBQQ__EndDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\nif(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){console.log('onBeforePriceRules  SBQQ__PriorQuantity__c is not null SBQQ__UpgradedSubscription__c');line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else{//Newly added QL in the amendment\nvar DateDebut=new Date(line.record['LPCR_DateDebut__c']);var DateFin=new Date(line.record['LPCR_DateFin__c']);if(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){if(DateDebut.getFullYear()===quoteStartDate.getFullYear()){console.log('onBeforePriceRules  both year equal');line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];line.record['LPCR_HoldBilling__c']='No';if(line.record['LPCR_DateFin__c']!=null&&DateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate>');}}else{line.record['LPCR_HoldBilling__c']='Yes';console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');}}}}else if(line.record['SBQQ__StartDate__c']!==null&&line.record['SBQQ__EndDate__c']===null){console.log('onBeforePriceRules  only end date null'+line.record['SBQQ__UpgradedSubscription__c']);if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){console.log('onBeforePriceRules  only end date null : set end date ');console.log(qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']));line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']!==null){line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];}}else if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']!='Amendment'&&line.record['SBQQ__ChargeType__c']=='Recurring'){console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');console.log('Date debut '+line.record['LPCR_DateDebut__c']);var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);console.log(quoteStartDate);//is the QL supposed to  start in this year? already started?\nif(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){console.log('LPCR_DateDebut__c not null');var dateDebut=new Date(line.record['LPCR_DateDebut__c']);if(dateDebut.getFullYear()<=quoteStartDate.getFullYear()){//is the QL still alive in this year? not ended?\t\t\t\t\t\t\t\nconsole.log('LPCR_DateFin__c not null');var dateFin=new Date(line.record['LPCR_DateFin__c']);console.log(dateFin);if(dateFin.getFullYear()>=quoteStartDate.getFullYear()){line.record['LPCR_HoldBilling__c']='No';console.log('onBeforePriceRules  LPCR_HoldBilling__c is set No');//SBQQ__EndDate__c logic\nif(dateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];console.log('onBeforePriceRules  SBQQ__EndDate__c is set LPCR_DateFin__c');}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';console.log('onBeforePriceRules  SBQQ__EndDate__c is set 31-12-Year<startdate> '+line.record['SBQQ__EndDate__c']);}//SBQQ__StartDate__c logic\nif(dateDebut.getFullYear()==quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];console.log('onBeforePriceRules  SBQQ__StartDate__c is set line LPCR_DateDebut__c');}}else{line.record['SBQQ__Quantity__c']=0;console.log('onBeforePriceRules  SBQQ__Quantity__c is set 0');}}else{line.record['LPCR_HoldBilling__c']='Yes';console.log('onBeforePriceRules  LPCR_HoldBilling__c is set Yes');}}}});}});}}console.log('@@@ codeList ');console.log(codeList);return Promise.resolve();}_export('onBeforePriceRules',onBeforePriceRules);function isFieldVisibleForObject(fieldName,quote,conn,objectName){if(objectName==='Quote__c'&&fieldName==='LPCR_TypeAvenant__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}if(objectName==='Quote__c'&&fieldName==='LPCR_DateResiliation__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}}_export('isFieldVisibleForObject',isFieldVisibleForObject);return{setters:[],execute:function(){;}};});"
        },
        {
            "attributes": {
                "type": "SBQQ__CustomScript__c",
                "referenceId": "SBQQ__CustomScript__cRef2"
            },
            "IsDeleted": false,
            "Name": "QuoteCalculatorPlugin working without FIlter for Record Type",
            "SBQQ__Code__c": "export function onAfterCalculate(quote, lines, conn) {\n    console.log('Quote : ' + quote.record[\"Id\"]);\n    console.log('LPCR_Contracted_Checkbox__c:');\n    console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);\n    if (quote.record[\"SBQQ__Type__c\"] == 'Renewal' && quote.record[\"LPCR_Added_Product_Using_QCP__c\"] == false && quote.record[\"LPCR_Contracted_Checkbox__c\"] == true) {\n        var newRecords = [];\n\n        var conditions = {\n            ProductCode: 'FraisInscriptionMac'\n        };\n        var fields = ['Id', 'ProductCode'];\n        return conn.sobject('Product2')\n            .find(conditions, fields)\n            .execute(function(err, records) {\n                console.log(records);\n                var product = records[0].Id;\n                console.log('product ' + product);\n                if (err) {\n                    return Promise.reject(err);\n                } else {\n\n                    if (true) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        newRecords.push({\n                            SBQQ__Product__c: product,\n                            SBQQ__Quote__c: quote.record[\"Id\"],\n                            SBQQ__Number__c: 100\n                        });\n                    }\n                    if (newRecords.length) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        return conn.sobject('SBQQ__QuoteLine__c').create(newRecords, function(err, ret) {\n                            console.log(ret);\n                        });\n                    }\n                }\n            });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforeCalculate(quoteModel, lines, conn) {\n    if (lines) {\n        lines.forEach((line) => {\n            const consumptionUnitPrice = line.record['LPCR_TauxHoraire__c'];\n\n            if (consumptionUnitPrice > 0 && line.consumptionSchedules) {\n                line.consumptionSchedules.forEach((cs, index) => {\n                    const rates = cs.getRates();\n                    if (rates) {\n                        rates.forEach((rate, index) => {\n                            const newPrice = consumptionUnitPrice;\n                            rate.set('SBQQ__Price__c', newPrice);\n                        });\n                    }\n                });\n            }\n\n        });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforePriceRules(quoteModel, quoteLineModels, conn) {\n    console.log('onBeforePriceRules: ');\n    console.log(quoteModel);\n\n    let recordTypeMap = new Map();\n    var qliUpgradedSubscriptionList = [];\n    let qliUpgradedSubscriptionMap = new Map();\n\n    if (quoteLineModels) {\n        quoteLineModels.forEach(function(line) {\n            if (line.record['SBQQ__UpgradedSubscription__c']) {\n                qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);\n            }\n        });\n        if (qliUpgradedSubscriptionList.length) {\n            var codeList = \"('\" + qliUpgradedSubscriptionList.join(\"', '\") + \"')\";\n\n            conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN ' + codeList)\n                .then(function(results) {\n                    if (results.totalSize) {\n                        results.records.forEach(function(record) {\n                            qliUpgradedSubscriptionMap.set('' + record.Id, record.SBQQ__EndDate__c);\n                        });\n                    }\n                });\n        }\n\n        if (quoteModel) {\n            var conditions = {\n                DeveloperName: 'Referencement',\n                SobjectType: 'SBQQ__Quote__c'\n            };\n            var fields = ['Id', 'DeveloperName'];\n            return conn.sobject('RecordType')\n                .find(conditions, fields)\n                .execute(function(err, records) {\n                    if (typeof records !== 'undefined') {\n                        records.forEach(function(recordType) {\n                            recordTypeMap.set(recordType.Id, recordType.DeveloperName);\n                        });\n                    }\n\n                    if (typeof quoteLineModels !== 'undefined') {\n                        quoteLineModels.forEach(function(line) {\n\t\t\t\t\t\t\t\n                            if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] == 'Amendment') {\n                                //we add this check to not override dates for the cloned line from ‘clone/cancel’ \n                                // it will have the exact dates as the original QL\n                                console.log('onBeforePriceRules RecordType and Type is true');\n                                if (line.record['LPCR_Clone__c'] == false && line.record['SBQQ__PriorQuantity__c'] != null) {\n                                    if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] === null) {\n\n                                        //Not a Newly added QL in the amendment\n                                        line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\n                                        if (line.record['SBQQ__UpgradedSubscription__c'] !== null) {\n                                            if (qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])) {\n                                                line.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n                                            }\n                                        }\n                                    } else if (line.record['SBQQ__StartDate__c'] !== null && line.record['SBQQ__EndDate__c'] === null) {\n                                        if (line.record['SBQQ__UpgradedSubscription__c'] !== null) {\n                                            if (qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])) {\n                                                line.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\n                                            }\n                                        }\n\n                                    } else if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] !== null) {\n                                        line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n                                    }\n                                } else if (line.record['LPCR_Clone__c'] == false && line.record['SBQQ__PriorQuantity__c'] == null) {\n                                    //Newly added QL in the amendment\n                                    var DateDebut = new Date(line.record['LPCR_DateDebut__c']);\n                                    var DateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                    if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n\t\t\t\t\t\t\t\t\t\tvar quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                        if (DateDebut.getFullYear() === quoteStartDate.getFullYear()) {\n                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                            line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                            if (line.record['LPCR_DateFin__c'] != null && DateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                                line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                            } else {\n                                                line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                            }\n                                        } else {\n                                            line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                        }\n                                    }\n                                }\n\n                            } else if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] != 'Amendment' && line.record['SBQQ__ChargeType__c'] == 'Recurring') {\n                                console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');                                \n\n                                //is the QL supposed to  start in this year? already started?\n                                if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n\t\t\t\t\t\t\t\t\tvar quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                    var dateDebut = new Date(line.record['LPCR_DateDebut__c']);\n\n                                    if (dateDebut.getFullYear() <= quoteStartDate.getFullYear()) {\n                                        //is the QL still alive in this year? not ended?\t\n                                        var dateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                        if (dateFin.getFullYear() >= quoteStartDate.getFullYear()) {\n\n                                            line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                            //SBQQ__EndDate__c logic\n                                            if (dateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                                line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                            } else {\n                                                line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                            }\n\n                                            //SBQQ__StartDate__c logic\n                                            if (dateDebut.getFullYear() == quoteStartDate.getFullYear()) {\n                                                line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                            }\n                                        } else {\n                                            line.record['SBQQ__Quantity__c'] = 0;\n                                        }\n                                    } else {\n                                        line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                    }\n                                }\n\n                            }\n\n                        });\n                    }\n                });\n        }\n    }\n\n    return Promise.resolve();\n}\n\nexport function isFieldVisibleForObject(fieldName, quote, conn, objectName) {\n\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_TypeAvenant__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_DateResiliation__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n};",
            "SBQQ__QuoteFields__c": "LPCR_Added_Product_Using_QCP__c\nLPCR_Contracted_Checkbox__c",
            "SBQQ__QuoteLineFields__c": "LPCR_TauxHoraire__c\nLPCR_HoldBilling__c\nLPCR_Clone__c",
            "SBQQ__TranspiledCode__c": "'use strict';System.register('QCPlugin____UIDFiller____',[],function(_export,_context){\"use strict\";function onAfterCalculate(quote,lines,conn){console.log('Quote : '+quote.record[\"Id\"]);console.log('LPCR_Contracted_Checkbox__c:');console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);if(quote.record[\"SBQQ__Type__c\"]=='Renewal'&&quote.record[\"LPCR_Added_Product_Using_QCP__c\"]==false&&quote.record[\"LPCR_Contracted_Checkbox__c\"]==true){var newRecords=[];var conditions={ProductCode:'FraisInscriptionMac'};var fields=['Id','ProductCode'];return conn.sobject('Product2').find(conditions,fields).execute(function(err,records){console.log(records);var product=records[0].Id;console.log('product '+product);if(err){return Promise.reject(err);}else{if(true){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;newRecords.push({SBQQ__Product__c:product,SBQQ__Quote__c:quote.record[\"Id\"],SBQQ__Number__c:100});}if(newRecords.length){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;return conn.sobject('SBQQ__QuoteLine__c').create(newRecords,function(err,ret){console.log(ret);});}}});}return Promise.resolve();}_export('onAfterCalculate',onAfterCalculate);function onBeforeCalculate(quoteModel,lines,conn){if(lines){lines.forEach(function(line){var consumptionUnitPrice=line.record['LPCR_TauxHoraire__c'];if(consumptionUnitPrice>0&&line.consumptionSchedules){line.consumptionSchedules.forEach(function(cs,index){var rates=cs.getRates();if(rates){rates.forEach(function(rate,index){var newPrice=consumptionUnitPrice;rate.set('SBQQ__Price__c',newPrice);});}});}});}return Promise.resolve();}_export('onBeforeCalculate',onBeforeCalculate);function onBeforePriceRules(quoteModel,quoteLineModels,conn){console.log('onBeforePriceRules: ');console.log(quoteModel);var recordTypeMap=new Map();var qliUpgradedSubscriptionList=[];var qliUpgradedSubscriptionMap=new Map();if(quoteLineModels){quoteLineModels.forEach(function(line){if(line.record['SBQQ__UpgradedSubscription__c']){qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);}});if(qliUpgradedSubscriptionList.length){var codeList=\"('\"+qliUpgradedSubscriptionList.join(\"', '\")+\"')\";conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN '+codeList).then(function(results){if(results.totalSize){results.records.forEach(function(record){qliUpgradedSubscriptionMap.set(''+record.Id,record.SBQQ__EndDate__c);});}});}if(quoteModel){var conditions={DeveloperName:'Referencement',SobjectType:'SBQQ__Quote__c'};var fields=['Id','DeveloperName'];return conn.sobject('RecordType').find(conditions,fields).execute(function(err,records){if(typeof records!=='undefined'){records.forEach(function(recordType){recordTypeMap.set(recordType.Id,recordType.DeveloperName);});}if(typeof quoteLineModels!=='undefined'){quoteLineModels.forEach(function(line){if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']=='Amendment'){//we add this check to not override dates for the cloned line from ‘clone/cancel’ \n// it will have the exact dates as the original QL\nconsole.log('onBeforePriceRules RecordType and Type is true');if(line.record['LPCR_Clone__c']==false&&line.record['SBQQ__PriorQuantity__c']!=null){if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']===null){//Not a Newly added QL in the amendment\nline.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']!==null&&line.record['SBQQ__EndDate__c']===null){if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']!==null){line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];}}else if(line.record['LPCR_Clone__c']==false&&line.record['SBQQ__PriorQuantity__c']==null){//Newly added QL in the amendment\nvar DateDebut=new Date(line.record['LPCR_DateDebut__c']);var DateFin=new Date(line.record['LPCR_DateFin__c']);if(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);if(DateDebut.getFullYear()===quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];line.record['LPCR_HoldBilling__c']='No';if(line.record['LPCR_DateFin__c']!=null&&DateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';}}else{line.record['LPCR_HoldBilling__c']='Yes';}}}}else if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']!='Amendment'&&line.record['SBQQ__ChargeType__c']=='Recurring'){console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');//is the QL supposed to  start in this year? already started?\nif(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);var dateDebut=new Date(line.record['LPCR_DateDebut__c']);if(dateDebut.getFullYear()<=quoteStartDate.getFullYear()){//is the QL still alive in this year? not ended?\t\nvar dateFin=new Date(line.record['LPCR_DateFin__c']);if(dateFin.getFullYear()>=quoteStartDate.getFullYear()){line.record['LPCR_HoldBilling__c']='No';//SBQQ__EndDate__c logic\nif(dateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';}//SBQQ__StartDate__c logic\nif(dateDebut.getFullYear()==quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];}}else{line.record['SBQQ__Quantity__c']=0;}}else{line.record['LPCR_HoldBilling__c']='Yes';}}}});}});}}return Promise.resolve();}_export('onBeforePriceRules',onBeforePriceRules);function isFieldVisibleForObject(fieldName,quote,conn,objectName){if(objectName==='Quote__c'&&fieldName==='LPCR_TypeAvenant__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}if(objectName==='Quote__c'&&fieldName==='LPCR_DateResiliation__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}}_export('isFieldVisibleForObject',isFieldVisibleForObject);return{setters:[],execute:function(){;}};});"
        },
        {
            "attributes": {
                "type": "SBQQ__CustomScript__c",
                "referenceId": "SBQQ__CustomScript__cRef3"
            },
            "IsDeleted": false,
            "Name": "qcp-cloneLineScript",
            "SBQQ__Code__c": "export function onAfterCloneLine(quote, clonedLines, conn)\n{\nconsole.log(clonedLines);\nvar newRecords = [];\nclonedLines.clonedLines.standard.forEach(function (line){\nconsole.log(line.record);\nconsole.log('this is con',conn);\nif(quote.record.LPCR_Uplift__c && line.record[\"SBQQ__ProductCode__c\"] === 'BerceauReservataire'){\n\tvar uplift = quote.record.SBQQ__RenewalUpliftRate__c;\n\tline.record[\"SBQQ__Uplift__c\"] = uplift;\n\tquote.record[\"LPCR_Indexation__c\"]=true;\n\tvar customerpriceunprorated=line.record[\"SBQQ__CustomerPrice__c\"] /line.record[\"SBQQ__ProrateMultiplier__c\"];\n\tline.record[\"LPCR_IndexationCustom__c\"] = customerpriceunprorated*(uplift/100);\n\tline.record[\"SBQQ__ListPrice__c\"] = customerpriceunprorated+(customerpriceunprorated*(uplift/100));\n\tline.record[\"LPCR_IndexationQuote__c\"] = true;\n\tif(line.record[\"SBQQ__AdditionalDiscountAmount__c\"])line.record[\"SBQQ__AdditionalDiscountAmount__c\"]=0;\n\tif(line.record[\"SBQQ__Discount__c\"])line.record[\"SBQQ__Discount__c\"]=0;\n\n}\n\n});\n\nreturn Promise.resolve();\n}",
            "SBQQ__QuoteFields__c": "LPCR_Uplift__c\nLPCR_Indexation__c",
            "SBQQ__QuoteLineFields__c": "LPCR_IndexationCustom__c\nLPCR_IndexationQuote__c\nLPCR_PrixUnitaire__c",
            "SBQQ__TranspiledCode__c": "'use strict';System.register('QCPlugin____UIDFiller____',[],function(_export,_context){\"use strict\";function onAfterCloneLine(quote,clonedLines,conn){console.log(clonedLines);var newRecords=[];clonedLines.clonedLines.standard.forEach(function(line){console.log(line.record);console.log('this is con',conn);if(quote.record.LPCR_Uplift__c&&line.record[\"SBQQ__ProductCode__c\"]==='BerceauReservataire'){var uplift=quote.record.SBQQ__RenewalUpliftRate__c;line.record[\"SBQQ__Uplift__c\"]=uplift;quote.record[\"LPCR_Indexation__c\"]=true;var customerpriceunprorated=line.record[\"SBQQ__CustomerPrice__c\"]/line.record[\"SBQQ__ProrateMultiplier__c\"];line.record[\"LPCR_IndexationCustom__c\"]=customerpriceunprorated*(uplift/100);line.record[\"SBQQ__ListPrice__c\"]=customerpriceunprorated+customerpriceunprorated*(uplift/100);line.record[\"LPCR_IndexationQuote__c\"]=true;if(line.record[\"SBQQ__AdditionalDiscountAmount__c\"])line.record[\"SBQQ__AdditionalDiscountAmount__c\"]=0;if(line.record[\"SBQQ__Discount__c\"])line.record[\"SBQQ__Discount__c\"]=0;}});return Promise.resolve();}_export('onAfterCloneLine',onAfterCloneLine);return{setters:[],execute:function(){}};});"
        },
        {
            "attributes": {
                "type": "SBQQ__CustomScript__c",
                "referenceId": "SBQQ__CustomScript__cRef4"
            },
            "IsDeleted": false,
            "Name": "QuoteCalculatorPlugin",
            "SBQQ__Code__c": "export function onAfterCalculate(quote, lines, conn) {\n    console.log('Quote : ' + quote.record[\"Id\"]);\n    console.log('LPCR_Contracted_Checkbox__c:');\n    console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);\n    if (quote.record[\"SBQQ__Type__c\"] == 'Renewal' && quote.record[\"LPCR_Added_Product_Using_QCP__c\"] == false && quote.record[\"LPCR_Contracted_Checkbox__c\"] == true) {\n        var newRecords = [];\n\n        var conditions = {\n            ProductCode: 'FraisInscriptionMac'\n        };\n        var fields = ['Id', 'ProductCode'];\n        return conn.sobject('Product2')\n            .find(conditions, fields)\n            .execute(function(err, records) {\n                console.log(records);\n                var product = records[0].Id;\n                console.log('product ' + product);\n                if (err) {\n                    return Promise.reject(err);\n                } else {\n\n                    if (true) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        newRecords.push({\n                            SBQQ__Product__c: product,\n                            SBQQ__Quote__c: quote.record[\"Id\"],\n                            SBQQ__Number__c: 100\n                        });\n                    }\n                    if (newRecords.length) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        return conn.sobject('SBQQ__QuoteLine__c').create(newRecords, function(err, ret) {\n                            console.log(ret);\n                        });\n                    }\n                }\n            });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforeCalculate(quoteModel, lines, conn) {\n    if (lines) {\n        lines.forEach((line) => {\n            const consumptionUnitPrice = line.record['LPCR_TauxHoraire__c'];\n\n            if (consumptionUnitPrice > 0 && line.consumptionSchedules) {\n                line.consumptionSchedules.forEach((cs, index) => {\n                    const rates = cs.getRates();\n                    if (rates) {\n                        rates.forEach((rate, index) => {\n                            const newPrice = consumptionUnitPrice;\n                            rate.set('SBQQ__Price__c', newPrice);\n                        });\n                    }\n                });\n            }\n\n        });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforePriceRules(quoteModel, quoteLineModels, conn) {\n    console.log('onBeforePriceRules: ');\n    console.log(quoteModel);\n\n    let recordTypeMap = new Map();\n    var qliUpgradedSubscriptionList = [];\n    let qliUpgradedSubscriptionMap = new Map();\n\n    if (quoteLineModels) {\n        quoteLineModels.forEach(function(line) {\n            if (line.record['SBQQ__UpgradedSubscription__c']) {\n                qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);\n            }\n        });\n        if (qliUpgradedSubscriptionList.length) {\n            var codeList = \"('\" + qliUpgradedSubscriptionList.join(\"', '\") + \"')\";\n\n            conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN ' + codeList)\n                .then(function(results) {\n                    if (results.totalSize) {\n                        results.records.forEach(function(record) {\n                            qliUpgradedSubscriptionMap.set('' + record.Id, record.SBQQ__EndDate__c);\n                        });\n                    }\n                });\n        }\n        // Get Quote RecordType Map\n        var recordTypeList = \"('Referencement','Referencement_Approuve')\";\n        var SobjectType = \"'SBQQ__Quote__c'\";\n\n        return conn.query('SELECT Id, DeveloperName FROM RecordType WHERE SobjectType = ' + SobjectType + ' AND DeveloperName IN ' + recordTypeList)\n            .then(function(results) {\n                if (results.totalSize) {\n                    results.records.forEach(function(record) {\n                        recordTypeMap.set('' + record.Id, record.DeveloperName);\n                    });\n                }\n                console.log('@@@recordTypeMap');\n                console.log(recordTypeMap);\n\n                if (typeof quoteLineModels !== 'undefined') {\n                    quoteLineModels.forEach(function(line) {\n                        console.log('@@@ QLI');\n\t\t\t\t\t\tconsole.log(line);\n                        if ((recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) || line.record['SBQQ__Quote__r']['RecordTypeId'] == null) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] == 'Amendment') {\n                            //we add this check to not override dates for the cloned line from ‘clone/cancel’ \n                            // it will have the exact dates as the original QL\n                            console.log('onBeforePriceRules RecordType and Type is true');\n                            if (line.record['LPCR_Clone__c'] == false && line.record['SBQQ__PriorQuantity__c'] != null) {\n                                if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] === null) {\n\n                                    //Not a Newly added QL in the amendment\n                                    line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\n                                    if (line.record['SBQQ__UpgradedSubscription__c'] !== null) {\n                                        if (qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])) {\n                                            line.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n                                        }\n                                    }\n                                } else if (line.record['SBQQ__StartDate__c'] !== null && line.record['SBQQ__EndDate__c'] === null) {\n                                    if (line.record['SBQQ__UpgradedSubscription__c'] !== null) {\n                                        if (qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])) {\n                                            line.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\n                                        }\n                                    }\n\n                                } else if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] !== null) {\n                                    line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n                                }\n                            } else if (line.record['LPCR_Clone__c'] == false && line.record['SBQQ__PriorQuantity__c'] == null) {\n                                //Newly added QL in the amendment\n                                var DateDebut = new Date(line.record['LPCR_DateDebut__c']);\n                                var DateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n                                    var quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                    if (DateDebut.getFullYear() === quoteStartDate.getFullYear()) {\n                                        line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                        line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                        if (line.record['LPCR_DateFin__c'] != null && DateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                            line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                        } else {\n                                            line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                        }\n                                    } else {\n                                        line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                    }\n                                }\n                            }\n\n                        } else if ((recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) || line.record['SBQQ__Quote__r']['RecordTypeId'] == null) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] != 'Amendment' && line.record['SBQQ__ChargeType__c'] == 'Recurring') {\n                            console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');\n\n                            //is the QL supposed to  start in this year? already started?\n                            if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n                                var quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                var dateDebut = new Date(line.record['LPCR_DateDebut__c']);\n\n                                if (dateDebut.getFullYear() <= quoteStartDate.getFullYear()) {\n                                    //is the QL still alive in this year? not ended?\t\n                                    var dateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                    if (dateFin.getFullYear() >= quoteStartDate.getFullYear()) {\n\n                                        line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                        //SBQQ__EndDate__c logic\n                                        if (dateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                            line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                        } else {\n                                            line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                        }\n\n                                        //SBQQ__StartDate__c logic\n                                        if (dateDebut.getFullYear() == quoteStartDate.getFullYear()) {\n                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                        }\n                                    } else {\n                                        line.record['SBQQ__Quantity__c'] = 0;\n                                    }\n                                } else {\n                                    line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                }\n                            }\n\n                        }\n\n                    });\n                }\n            });\n\n    }\n\n    return Promise.resolve();\n}\n\nexport function isFieldVisibleForObject(fieldName, quote, conn, objectName) {\n\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_TypeAvenant__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_DateResiliation__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n}\n\n\n;",
            "SBQQ__QuoteFields__c": "LPCR_Added_Product_Using_QCP__c\nLPCR_Contracted_Checkbox__c",
            "SBQQ__QuoteLineFields__c": "LPCR_TauxHoraire__c\nLPCR_HoldBilling__c\nLPCR_Clone__c",
            "SBQQ__TranspiledCode__c": "'use strict';System.register('QCPlugin____UIDFiller____',[],function(_export,_context){\"use strict\";function onAfterCalculate(quote,lines,conn){console.log('Quote : '+quote.record[\"Id\"]);console.log('LPCR_Contracted_Checkbox__c:');console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);if(quote.record[\"SBQQ__Type__c\"]=='Renewal'&&quote.record[\"LPCR_Added_Product_Using_QCP__c\"]==false&&quote.record[\"LPCR_Contracted_Checkbox__c\"]==true){var newRecords=[];var conditions={ProductCode:'FraisInscriptionMac'};var fields=['Id','ProductCode'];return conn.sobject('Product2').find(conditions,fields).execute(function(err,records){console.log(records);var product=records[0].Id;console.log('product '+product);if(err){return Promise.reject(err);}else{if(true){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;newRecords.push({SBQQ__Product__c:product,SBQQ__Quote__c:quote.record[\"Id\"],SBQQ__Number__c:100});}if(newRecords.length){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;return conn.sobject('SBQQ__QuoteLine__c').create(newRecords,function(err,ret){console.log(ret);});}}});}return Promise.resolve();}_export('onAfterCalculate',onAfterCalculate);function onBeforeCalculate(quoteModel,lines,conn){if(lines){lines.forEach(function(line){var consumptionUnitPrice=line.record['LPCR_TauxHoraire__c'];if(consumptionUnitPrice>0&&line.consumptionSchedules){line.consumptionSchedules.forEach(function(cs,index){var rates=cs.getRates();if(rates){rates.forEach(function(rate,index){var newPrice=consumptionUnitPrice;rate.set('SBQQ__Price__c',newPrice);});}});}});}return Promise.resolve();}_export('onBeforeCalculate',onBeforeCalculate);function onBeforePriceRules(quoteModel,quoteLineModels,conn){console.log('onBeforePriceRules: ');console.log(quoteModel);var recordTypeMap=new Map();var qliUpgradedSubscriptionList=[];var qliUpgradedSubscriptionMap=new Map();if(quoteLineModels){quoteLineModels.forEach(function(line){if(line.record['SBQQ__UpgradedSubscription__c']){qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);}});if(qliUpgradedSubscriptionList.length){var codeList=\"('\"+qliUpgradedSubscriptionList.join(\"', '\")+\"')\";conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN '+codeList).then(function(results){if(results.totalSize){results.records.forEach(function(record){qliUpgradedSubscriptionMap.set(''+record.Id,record.SBQQ__EndDate__c);});}});}// Get Quote RecordType Map\nvar recordTypeList=\"('Referencement','Referencement_Approuve')\";var SobjectType=\"'SBQQ__Quote__c'\";return conn.query('SELECT Id, DeveloperName FROM RecordType WHERE SobjectType = '+SobjectType+' AND DeveloperName IN '+recordTypeList).then(function(results){if(results.totalSize){results.records.forEach(function(record){recordTypeMap.set(''+record.Id,record.DeveloperName);});}console.log('@@@recordTypeMap');console.log(recordTypeMap);if(typeof quoteLineModels!=='undefined'){quoteLineModels.forEach(function(line){console.log('@@@ QLI');console.log(line);if((recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])||line.record['SBQQ__Quote__r']['RecordTypeId']==null)&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']=='Amendment'){//we add this check to not override dates for the cloned line from ‘clone/cancel’ \n// it will have the exact dates as the original QL\nconsole.log('onBeforePriceRules RecordType and Type is true');if(line.record['LPCR_Clone__c']==false&&line.record['SBQQ__PriorQuantity__c']!=null){if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']===null){//Not a Newly added QL in the amendment\nline.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']!==null&&line.record['SBQQ__EndDate__c']===null){if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']!==null){line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];}}else if(line.record['LPCR_Clone__c']==false&&line.record['SBQQ__PriorQuantity__c']==null){//Newly added QL in the amendment\nvar DateDebut=new Date(line.record['LPCR_DateDebut__c']);var DateFin=new Date(line.record['LPCR_DateFin__c']);if(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);if(DateDebut.getFullYear()===quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];line.record['LPCR_HoldBilling__c']='No';if(line.record['LPCR_DateFin__c']!=null&&DateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';}}else{line.record['LPCR_HoldBilling__c']='Yes';}}}}else if((recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])||line.record['SBQQ__Quote__r']['RecordTypeId']==null)&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']!='Amendment'&&line.record['SBQQ__ChargeType__c']=='Recurring'){console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');//is the QL supposed to  start in this year? already started?\nif(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);var dateDebut=new Date(line.record['LPCR_DateDebut__c']);if(dateDebut.getFullYear()<=quoteStartDate.getFullYear()){//is the QL still alive in this year? not ended?\t\nvar dateFin=new Date(line.record['LPCR_DateFin__c']);if(dateFin.getFullYear()>=quoteStartDate.getFullYear()){line.record['LPCR_HoldBilling__c']='No';//SBQQ__EndDate__c logic\nif(dateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';}//SBQQ__StartDate__c logic\nif(dateDebut.getFullYear()==quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];}}else{line.record['SBQQ__Quantity__c']=0;}}else{line.record['LPCR_HoldBilling__c']='Yes';}}}});}});}return Promise.resolve();}_export('onBeforePriceRules',onBeforePriceRules);function isFieldVisibleForObject(fieldName,quote,conn,objectName){if(objectName==='Quote__c'&&fieldName==='LPCR_TypeAvenant__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}if(objectName==='Quote__c'&&fieldName==='LPCR_DateResiliation__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}}_export('isFieldVisibleForObject',isFieldVisibleForObject);return{setters:[],execute:function(){;}};});"
        },
        {
            "attributes": {
                "type": "SBQQ__CustomScript__c",
                "referenceId": "SBQQ__CustomScript__cRef5"
            },
            "IsDeleted": false,
            "Name": "QuoteCalculatorPlugin 26",
            "SBQQ__Code__c": "export function onAfterCalculate(quote, lines, conn) {\n    console.log('Quote : ' + quote.record[\"Id\"]);\n    console.log('LPCR_Contracted_Checkbox__c:');\n    console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);\n    if (quote.record[\"SBQQ__Type__c\"] == 'Renewal' && quote.record[\"LPCR_Added_Product_Using_QCP__c\"] == false && quote.record[\"LPCR_Contracted_Checkbox__c\"] == true) {\n        var newRecords = [];\n\n        var conditions = {\n            ProductCode: 'FraisInscriptionMac'\n        };\n        var fields = ['Id', 'ProductCode'];\n        return conn.sobject('Product2')\n            .find(conditions, fields)\n            .execute(function(err, records) {\n                console.log(records);\n                var product = records[0].Id;\n                console.log('product ' + product);\n                if (err) {\n                    return Promise.reject(err);\n                } else {\n\n                    if (true) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        newRecords.push({\n                            SBQQ__Product__c: product,\n                            SBQQ__Quote__c: quote.record[\"Id\"],\n                            SBQQ__Number__c: 100\n                        });\n                    }\n                    if (newRecords.length) {\n                        quote.record[\"LPCR_Added_Product_Using_QCP__c\"] = true;\n                        return conn.sobject('SBQQ__QuoteLine__c').create(newRecords, function(err, ret) {\n                            console.log(ret);\n                        });\n                    }\n                }\n            });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforeCalculate(quoteModel, lines, conn) {\n    if (lines) {\n        lines.forEach((line) => {\n            const consumptionUnitPrice = line.record['LPCR_TauxHoraire__c'];\n\n            if (consumptionUnitPrice > 0 && line.consumptionSchedules) {\n                line.consumptionSchedules.forEach((cs, index) => {\n                    const rates = cs.getRates();\n                    if (rates) {\n                        rates.forEach((rate, index) => {\n                            const newPrice = consumptionUnitPrice;\n                            rate.set('SBQQ__Price__c', newPrice);\n                        });\n                    }\n                });\n            }\n\n        });\n    }\n    return Promise.resolve();\n}\n\nexport function onBeforePriceRules(quoteModel, quoteLineModels, conn) {\n    console.log('onBeforePriceRules @@: ');\n    console.log(quoteModel);\n\n    let recordTypeMap = new Map();\n    var qliUpgradedSubscriptionList = [];\n    let qliUpgradedSubscriptionMap = new Map();\n\n    if (quoteLineModels) {\n        quoteLineModels.forEach(function(line) {\n            if (line.record['SBQQ__UpgradedSubscription__c']) {\n                qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);\n            }\n        });\n        if (qliUpgradedSubscriptionList.length) {\n            var codeList = \"('\" + qliUpgradedSubscriptionList.join(\"', '\") + \"')\";\n\n            conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN ' + codeList)\n                .then(function(results) {\n                    if (results.totalSize) {\n                        results.records.forEach(function(record) {\n                            qliUpgradedSubscriptionMap.set('' + record.Id, record.SBQQ__EndDate__c);\n                        });\n                    }\n                });\n        }\n\n        if (quoteModel) {\n            var conditions = {\n                DeveloperName: 'Referencement',\n                SobjectType: 'SBQQ__Quote__c'\n            };\n            var fields = ['Id', 'DeveloperName'];\n            return conn.sobject('RecordType')\n                .find(conditions, fields)\n                .execute(function(err, records) {\n                    if (typeof records !== 'undefined') {\n                        records.forEach(function(recordType) {\n                            recordTypeMap.set(recordType.Id, recordType.DeveloperName);\n                        });\n                    }\n\n                    if (typeof quoteLineModels !== 'undefined') {\n                        quoteLineModels.forEach(function(line) {\n\n                            if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] == 'Amendment') {\n                                //we add this check to not override dates for the cloned line from ‘clone/cancel’ \n                                // it will have the exact dates as the original QL\n                                console.log('onBeforePriceRules RecordType and Type is true');\n                                if (line.record['LPCR_Clone__c'] == false && line.record['SBQQ__PriorQuantity__c'] != null) {\n                                    if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] === null) {\n\n                                        //Not a Newly added QL in the amendment\n                                        line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n\n                                        if (line.record['SBQQ__UpgradedSubscription__c'] !== null) {\n                                            if (qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])) {\n                                                line.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n                                            }\n                                        }\n                                    } else if (line.record['SBQQ__StartDate__c'] !== null && line.record['SBQQ__EndDate__c'] === null) {\n                                        if (line.record['SBQQ__UpgradedSubscription__c'] !== null) {\n                                            if (qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])) {\n                                                line.record['SBQQ__EndDate__c'] = qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);\n\n                                            }\n                                        }\n\n                                    } else if (line.record['SBQQ__StartDate__c'] === null && line.record['SBQQ__EndDate__c'] !== null) {\n                                        line.record['SBQQ__StartDate__c'] = line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];\n                                    }\n                                } else if (line.record['LPCR_Clone__c'] == false && line.record['SBQQ__PriorQuantity__c'] == null) {\n                                    //Newly added QL in the amendment\n                                    var DateDebut = new Date(line.record['LPCR_DateDebut__c']);\n                                    var DateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                    if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n\t\t\t\t\t\t\t\t\t\tvar quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                        if (DateDebut.getFullYear() === quoteStartDate.getFullYear()) {\n                                            line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                            line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                            if (line.record['LPCR_DateFin__c'] != null && DateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                                line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                            } else {\n                                                line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                            }\n                                        } else {\n                                            line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                        }\n                                    }\n                                }\n\n                            } else if (recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId']) && line.record['SBQQ__Quote__r']['SBQQ__Type__c'] != 'Amendment' && line.record['SBQQ__ChargeType__c'] == 'Recurring') {\n                                console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');                                \n\n                                //is the QL supposed to  start in this year? already started?\n                                if (line.record['LPCR_DateDebut__c'] != null && line.record['LPCR_DateFin__c'] != null && line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'] != null) {\n\t\t\t\t\t\t\t\t\tvar quoteStartDate = new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);\n                                    var dateDebut = new Date(line.record['LPCR_DateDebut__c']);\n\n                                    if (dateDebut.getFullYear() <= quoteStartDate.getFullYear()) {\n                                        //is the QL still alive in this year? not ended?\t\n                                        var dateFin = new Date(line.record['LPCR_DateFin__c']);\n\n                                        if (dateFin.getFullYear() >= quoteStartDate.getFullYear()) {\n\n                                            line.record['LPCR_HoldBilling__c'] = 'No';\n\n                                            //SBQQ__EndDate__c logic\n                                            if (dateFin < new Date(quoteStartDate.getFullYear(), 11, 31)) {\n                                                line.record['SBQQ__EndDate__c'] = line.record['LPCR_DateFin__c'];\n                                            } else {\n                                                line.record['SBQQ__EndDate__c'] = '' + quoteStartDate.getFullYear() + '-12-31';\n                                            }\n\n                                            //SBQQ__StartDate__c logic\n                                            if (dateDebut.getFullYear() == quoteStartDate.getFullYear()) {\n                                                line.record['SBQQ__StartDate__c'] = line.record['LPCR_DateDebut__c'];\n                                            }\n                                        } else {\n                                            line.record['SBQQ__Quantity__c'] = 0;\n                                        }\n                                    } else {\n                                        line.record['LPCR_HoldBilling__c'] = 'Yes';\n                                    }\n                                }\n\n                            }\n\n                        });\n                    }\n                });\n        }\n    }\n\n    return Promise.resolve();\n}\n\nexport function isFieldVisibleForObject(fieldName, quote, conn, objectName) {\n\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_TypeAvenant__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n    if (objectName === 'Quote__c' && fieldName === 'LPCR_DateResiliation__c') {\n        if (quote.SBQQ__Type__c == 'Quote') {\n            return false;\n        }\n    }\n};",
            "SBQQ__QuoteFields__c": "LPCR_Added_Product_Using_QCP__c\nLPCR_Contracted_Checkbox__c",
            "SBQQ__QuoteLineFields__c": "LPCR_TauxHoraire__c\nLPCR_HoldBilling__c\nLPCR_Clone__c",
            "SBQQ__TranspiledCode__c": "'use strict';System.register('QCPlugin____UIDFiller____',[],function(_export,_context){\"use strict\";function onAfterCalculate(quote,lines,conn){console.log('Quote : '+quote.record[\"Id\"]);console.log('LPCR_Contracted_Checkbox__c:');console.log(quote.record[\"LPCR_Contracted_Checkbox__c\"]);if(quote.record[\"SBQQ__Type__c\"]=='Renewal'&&quote.record[\"LPCR_Added_Product_Using_QCP__c\"]==false&&quote.record[\"LPCR_Contracted_Checkbox__c\"]==true){var newRecords=[];var conditions={ProductCode:'FraisInscriptionMac'};var fields=['Id','ProductCode'];return conn.sobject('Product2').find(conditions,fields).execute(function(err,records){console.log(records);var product=records[0].Id;console.log('product '+product);if(err){return Promise.reject(err);}else{if(true){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;newRecords.push({SBQQ__Product__c:product,SBQQ__Quote__c:quote.record[\"Id\"],SBQQ__Number__c:100});}if(newRecords.length){quote.record[\"LPCR_Added_Product_Using_QCP__c\"]=true;return conn.sobject('SBQQ__QuoteLine__c').create(newRecords,function(err,ret){console.log(ret);});}}});}return Promise.resolve();}_export('onAfterCalculate',onAfterCalculate);function onBeforeCalculate(quoteModel,lines,conn){if(lines){lines.forEach(function(line){var consumptionUnitPrice=line.record['LPCR_TauxHoraire__c'];if(consumptionUnitPrice>0&&line.consumptionSchedules){line.consumptionSchedules.forEach(function(cs,index){var rates=cs.getRates();if(rates){rates.forEach(function(rate,index){var newPrice=consumptionUnitPrice;rate.set('SBQQ__Price__c',newPrice);});}});}});}return Promise.resolve();}_export('onBeforeCalculate',onBeforeCalculate);function onBeforePriceRules(quoteModel,quoteLineModels,conn){console.log('onBeforePriceRules @@: ');console.log(quoteModel);var recordTypeMap=new Map();var qliUpgradedSubscriptionList=[];var qliUpgradedSubscriptionMap=new Map();if(quoteLineModels){quoteLineModels.forEach(function(line){if(line.record['SBQQ__UpgradedSubscription__c']){qliUpgradedSubscriptionList.push(line.record['SBQQ__UpgradedSubscription__c']);}});if(qliUpgradedSubscriptionList.length){var codeList=\"('\"+qliUpgradedSubscriptionList.join(\"', '\")+\"')\";conn.query('SELECT Id, SBQQ__EndDate__c FROM SBQQ__Subscription__c WHERE Id IN '+codeList).then(function(results){if(results.totalSize){results.records.forEach(function(record){qliUpgradedSubscriptionMap.set(''+record.Id,record.SBQQ__EndDate__c);});}});}if(quoteModel){var conditions={DeveloperName:'Referencement',SobjectType:'SBQQ__Quote__c'};var fields=['Id','DeveloperName'];return conn.sobject('RecordType').find(conditions,fields).execute(function(err,records){if(typeof records!=='undefined'){records.forEach(function(recordType){recordTypeMap.set(recordType.Id,recordType.DeveloperName);});}if(typeof quoteLineModels!=='undefined'){quoteLineModels.forEach(function(line){if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']=='Amendment'){//we add this check to not override dates for the cloned line from ‘clone/cancel’ \n// it will have the exact dates as the original QL\nconsole.log('onBeforePriceRules RecordType and Type is true');if(line.record['LPCR_Clone__c']==false&&line.record['SBQQ__PriorQuantity__c']!=null){if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']===null){//Not a Newly added QL in the amendment\nline.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']!==null&&line.record['SBQQ__EndDate__c']===null){if(line.record['SBQQ__UpgradedSubscription__c']!==null){if(qliUpgradedSubscriptionMap.has(line.record['SBQQ__UpgradedSubscription__c'])){line.record['SBQQ__EndDate__c']=qliUpgradedSubscriptionMap.get(line.record['SBQQ__UpgradedSubscription__c']);}}}else if(line.record['SBQQ__StartDate__c']===null&&line.record['SBQQ__EndDate__c']!==null){line.record['SBQQ__StartDate__c']=line.record['SBQQ__Quote__r']['SBQQ__StartDate__c'];}}else if(line.record['LPCR_Clone__c']==false&&line.record['SBQQ__PriorQuantity__c']==null){//Newly added QL in the amendment\nvar DateDebut=new Date(line.record['LPCR_DateDebut__c']);var DateFin=new Date(line.record['LPCR_DateFin__c']);if(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);if(DateDebut.getFullYear()===quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];line.record['LPCR_HoldBilling__c']='No';if(line.record['LPCR_DateFin__c']!=null&&DateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';}}else{line.record['LPCR_HoldBilling__c']='Yes';}}}}else if(recordTypeMap.has(line.record['SBQQ__Quote__r']['RecordTypeId'])&&line.record['SBQQ__Quote__r']['SBQQ__Type__c']!='Amendment'&&line.record['SBQQ__ChargeType__c']=='Recurring'){console.log('onBeforePriceRules Quote type not equal Amendment and charge type Recurring');//is the QL supposed to  start in this year? already started?\nif(line.record['LPCR_DateDebut__c']!=null&&line.record['LPCR_DateFin__c']!=null&&line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']!=null){var quoteStartDate=new Date(line.record['SBQQ__Quote__r']['SBQQ__StartDate__c']);var dateDebut=new Date(line.record['LPCR_DateDebut__c']);if(dateDebut.getFullYear()<=quoteStartDate.getFullYear()){//is the QL still alive in this year? not ended?\t\nvar dateFin=new Date(line.record['LPCR_DateFin__c']);if(dateFin.getFullYear()>=quoteStartDate.getFullYear()){line.record['LPCR_HoldBilling__c']='No';//SBQQ__EndDate__c logic\nif(dateFin<new Date(quoteStartDate.getFullYear(),11,31)){line.record['SBQQ__EndDate__c']=line.record['LPCR_DateFin__c'];}else{line.record['SBQQ__EndDate__c']=''+quoteStartDate.getFullYear()+'-12-31';}//SBQQ__StartDate__c logic\nif(dateDebut.getFullYear()==quoteStartDate.getFullYear()){line.record['SBQQ__StartDate__c']=line.record['LPCR_DateDebut__c'];}}else{line.record['SBQQ__Quantity__c']=0;}}else{line.record['LPCR_HoldBilling__c']='Yes';}}}});}});}}return Promise.resolve();}_export('onBeforePriceRules',onBeforePriceRules);function isFieldVisibleForObject(fieldName,quote,conn,objectName){if(objectName==='Quote__c'&&fieldName==='LPCR_TypeAvenant__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}if(objectName==='Quote__c'&&fieldName==='LPCR_DateResiliation__c'){if(quote.SBQQ__Type__c=='Quote'){return false;}}}_export('isFieldVisibleForObject',isFieldVisibleForObject);return{setters:[],execute:function(){;}};});"
        }
    ]
}