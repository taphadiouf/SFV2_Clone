/**
* @author E.Yhuellou
* @date 31/01/2021
* @Description Class allowing to send document to LPCR GED
*/
public with sharing class QA001_CalloutEnvoieDocumentGED implements Queueable,Database.AllowsCallouts {

    private String className = QA001_CalloutEnvoieDocumentGED.class.getName();
    private String ownerId;
    private String docSfId;
    private String name;
    private String binary;
    private String currentMail;
    private String currentParentObjectId;
    private blng__Invoice__c currentInvoice;

    // ownerSfId : Owner of Attachement 
    // docSfID : Id of Attachement generated by Salesforce
    // name : Name of the attachement
    // binaryDocument : Document content
    // invoice : (Optional) invoice related to document
    // mail : mail adress to be sent
    public QA001_CalloutEnvoieDocumentGED(String ownerSfId, String docSfID, String name, String binaryDocument, blng__Invoice__c invoice, String mail) {

        this.ownerId = ownerSfId;
        this.docSfId = docSfID;
        this.name = name;
        this.binary = binaryDocument;
        this.currentInvoice = invoice;
        this.currentMail = mail;
        this.currentParentObjectId = docSfID;
    }   

    public void execute(QueueableContext context) {

        String errorMsg = '';
        HttpResponse response;
        final String WS_NOM_SERVICE  = 'LPCR_ENVOIE_DOCUMENT';
        Id CrecheSfId;
        Map<Id,blng__Invoice__c> invoiceToUpdate = new Map<Id,blng__Invoice__c>();
        WRP004_APISaveDocument data;
        
        PAD.Log(className, 'execute', 'start');
        
        try {

            Http http = new Http();
            HttpRequest request = new HttpRequest();
            LPCR_Environnement__c envCS = LPCR_Environnement__c.getInstance();
        
            request.setEndpoint('callout:DEV_SEND_DOCUMENT');
            if('UAT'.equals(envCS.Nom__c)) request.setEndpoint('callout:UAT_SEND_DOCUMENT');
            if('PROD'.equals(envCS.Nom__c)) request.setEndpoint('callout:PROD_SEND_DOCUMENT');
        
            request.setMethod('POST');
            request.setHeader('Content-Type', 'application/json;charset=UTF-8');
            
            if(Name.contains('Facture')) {
                 CrecheSfId = getB2CFactureCrecheID(this.ownerId);
            }
            if(Name.contains('Contrat')) {
                 CrecheSfId = getB2CContractCrecheID(this.ownerId);
            }
        
            data = new WRP004_APISaveDocument(this.ownerId, DocSfID, Name, this.binary, CrecheSfId);
            request.setBody(JSON.serialize(data));
            
            response = http.send(request);

            PAD.Log(className, 'executeSendDocumentCallout','response:' + response);
			PAD.Log(className, 'executeSendDocumentCallout','response.getBody():' + response.getBody());
            PAD.Log(className, 'execute', 'Doc Sent by Callout...');
            
        }
        catch (System.CalloutException e) { 

            PAD.Log(className, 'execute', 'In catch');
            errorMsg = String.valueOf(e);
        }
        finally {

            if (this.currentInvoice != null) {
                this.currentParentObjectId = currentInvoice.Id;
            }

            if (errorMsg != '') { // ERROR
                UM001_LogManager.writeLogActivityWithoutFuture(UM010_Constant.LOG_SEND_DOC_TO_GED,className, 'Callout', this.currentParentObjectId, 'body:' + JSON.serialize(data) +  ' - Apex Callout Exception:' + errorMsg, UM010_Constant.ERROR);  
            }
            
            if(response != null && response.getStatusCode() != null){

                if (String.valueOf(response.getStatusCode()).equals('200')) { // SUCCESS

                    if(this.currentInvoice != null) { // Chain Doc List (QA002) and Email sending (QA003) after conga invoice generation + update status to Envoyéé
                        
                        currentInvoice.LPCR_StatutFacture__c = 'Envoyée';
                        invoiceToUpdate.put(currentInvoice.id,currentInvoice);
                        QA002_CalloutListeDocumentGED docListJob = new QA002_CalloutListeDocumentGED(this.ownerId, 'Facture', this.currentMail, '', '', '', 'FACTURE_CONGA');
                        ID jobID = System.enqueueJob(docListJob);
                    }

                    UM001_LogManager.writeLogActivityWithoutFuture(UM010_Constant.LOG_SEND_DOC_TO_GED, className, 'Callout', this.currentParentObjectId, /*'body:' + JSON.serialize(data) +*/ ' - statusCode:' + String.valueOf(response.getStatusCode()) + ' - this.ownerId:' + this.ownerId, UM010_Constant.SUCCESS);  

                    if(invoiceToUpdate.size() !=0 ){
                        update invoiceToUpdate.values();
                    }
                
                } else { // ERROR
                    UM001_LogManager.writeLogActivityWithoutFuture(UM010_Constant.LOG_SEND_DOC_TO_GED, className, 'Callout', this.currentParentObjectId,  /*'body:' + JSON.serialize(data) +*/ 'Exception:' + String.valueOf(response.getStatusCode()) + ' - statusCode:' + String.valueOf(response.getStatusCode()) + ' - Attachment.Id:' + DocSfID + ' - this.ownerId:' + this.ownerId, UM010_Constant.ERROR);  
                }
            }else{ // ERROR
                UM001_LogManager.writeLogActivityWithoutFuture(UM010_Constant.LOG_SEND_DOC_TO_GED, className, 'Callout', this.currentParentObjectId,  /*'body:' + JSON.serialize(data) +*/ 'Exception: Internal Error. Response is null! - Attachment.Id:' + DocSfID + ' - this.ownerId:' + this.ownerId, UM010_Constant.ERROR);  
            }
            
        }

    }

    public static Id getB2CFactureCrecheID(String OwnerSfId){

        Id factureCrecheId;
        Id accueilRecTypeId = EM003_RecordTypeEntity.getRecTypeIdByObjectAndName(Label.LPCR_Account,Label.LPCR_Famille);

        blng__Invoice__c tmpFacture = [SELECT Id,LPCR_Creche__c,blng__Account__c FROM blng__Invoice__c WHERE blng__Account__r.RecordTypeId =: accueilRecTypeId AND ID =: OwnerSfId order by createdDAte desc limit 1];
        
        if (tmpFacture != null) {
            factureCrecheId = tmpFacture.LPCR_Creche__c;
        }

        return factureCrecheId;
    }

    public static Id getB2CContractCrecheID(String OwnerSfId){

        String errorMsg = '';
        Id contractCrecheId;
        try {
            Id acceuilRecTypeId = EM003_RecordTypeEntity.getRecTypeIdByObjectAndName(Label.LPCR_Quote,Label.LPCR_ContratA);
            Id acceuilApprRecTypeId = EM003_RecordTypeEntity.getRecTypeIdByObjectAndName(Label.LPCR_Quote,Label.LPCR_Accueil_Approuve);

            Id acceuilDevisId = [SELECT Id,LPCR_Devis__c FROM echosign_dev1__SIGN_Agreement__c WHERE 
                (LPCR_Devis__r.RecordTypeId =: acceuilRecTypeId OR 
                LPCR_Devis__r.RecordTypeId =: acceuilApprRecTypeId) 
                AND 
                ID =: OwnerSfId].LPCR_Devis__c;
            
            List<SBQQ__QuoteLine__c> relatedQuoteLignes = [SELECT Id, SBQQ__Quote__c  FROM SBQQ__QuoteLine__c WHERE SBQQ__Quote__c =: acceuilDevisId];
            
            Set<Id> quoteLigneIds = UM003_TypeManager.getIdsOfListObjects(relatedQuoteLignes);
            
            List<OrderItem> relatedOrderItems = [SELECT Id, SBQQ__QuoteLine__c, SBQQ__Contract__c FROM OrderItem WHERE SBQQ__QuoteLine__c IN: quoteLigneIds ];
            
            Id relatedContractId = relatedOrderItems.get(0).SBQQ__Contract__c;
            
            contractCrecheId = [SELECT Id, LPCR_Creche__c  FROM COntract WHERE Id=: relatedContractId ].LPCR_Creche__c;
            
        } catch (Exception e ) {
            errorMsg = e.getMessage();
        } finally {
            if (errorMsg != '') {
                UM001_LogManager.writeLogActivityWithoutFuture(UM010_Constant.LOG_SEND_DOC_TO_GED,'SM017_SendDocument_Callout', 'Callout', null,  'Apex Callout Exception:' + errorMsg, UM010_Constant.ERROR);  
            }
            
        }
        
        return contractCrecheId;
    }
}
